name: Simulate Production Deploy and Comment on Issue

on:
  push:
    branches:
      - main

permissions:
  issues: write
  pull-requests: read
  contents: read

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  deploy-and-comment:
    runs-on: ubuntu-latest
    deployment: production
    steps:
      - uses: actions/checkout@v4
      - name: Get merged PR info
        id: pr
        run: |
          # Find the PR related to this push (latest commit on main)
          COMMIT_SHA="${{ github.sha }}"
          echo "Looking for PR that merged $COMMIT_SHA"

          PR_JSON=$(gh pr list --state merged --search "$COMMIT_SHA in:body" --json number,title,body --jq '.[0]')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          PR_BODY=$(echo "$PR_JSON" | jq -r '.body')

          echo "PR #$PR_NUMBER was merged"

          # Extract issue number (e.g. "Closes #123")
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oE '(Closes|Fixes|Resolves) #?[0-9]+' | grep -oE '[0-9]+')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "❌ No issue reference found."
            exit 0
          fi

          echo "Linked issue: #$ISSUE_NUMBER"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Simulate production deploy
        run: |
          echo "🚀 Simulating deployment for PR #${{ steps.pr.outputs.pr_number }}..."
          sleep 2
          echo "✅ Deployed!"

      - name: Comment on linked issue
        if: steps.pr.outputs.issue_number != ''
        run: |
          gh issue comment ${{ steps.pr.outputs.issue_number }} \
            --body "✅ This has been deployed to production via PR #${{ steps.pr.outputs.pr_number }}."
